# 第一步：数据库设计与搭建指南
## （IT 小白专用版）

> **适用人群**：零基础 IT 小白、首次接触数据库的毕业生  
> **预计耗时**：7-10 天  
> **难度等级**：⭐⭐☆☆☆（入门级）  
> **本文档目标**：手把手教你完成毕业设计的第一步——数据库设计与搭建

---

## 📋 本章你将完成什么？

完成本指南后，你将拥有：

- ✅ 一个设计好的数据库（包含 7 张表）
- ✅ 本地可运行的 MySQL 数据库环境
- ✅ 完整的建表 SQL 脚本
- ✅ 测试数据（可直接使用）
- ✅ 数据库设计文档（用于论文）

---

## 📚 第一部分：基础知识（必读，30 分钟）

### 1.1 什么是数据库？

**通俗理解**：数据库就是一个"电子表格本"，用来存储和管理数据。

| 概念 | 通俗解释 | 举例 |
|------|----------|------|
| **数据库 (Database)** | 一个完整的"数据本子" | `dental_clinic`（牙科诊所数据库） |
| **表 (Table)** | 本子里的一页纸 | `patients`（患者信息表） |
| **字段 (Column)** | 表格的列 | `name`（姓名）、`age`（年龄） |
| **记录 (Row)** | 表格的一行数据 | 某个具体患者的信息 |
| **主键 (Primary Key)** | 唯一标识一条记录的字段 | `id`（每个人的编号都不同） |
| **外键 (Foreign Key)** | 关联另一张表的字段 | `patient_id`（指向患者表） |

### 1.2 什么是 MySQL？

**MySQL** 是一个免费、开源的数据库软件，就像 Excel 一样可以存储数据，但更强大、更安全。

### 1.3 什么是 ER 图？

**ER 图**（实体关系图）就是画出来告诉别人：
- 系统里有哪些"东西"（实体）
- 这些"东西"之间有什么关系

**示例**：
```
┌─────────────┐       1:N        ┌──────────────┐
│   患者       │─────────────────│   复诊计划    │
│  (patient)  │                  │(appointment) │
└─────────────┘                  └──────────────┘
      │
      │ 1:N
      │
      ▼
┌─────────────┐
│  治疗记录    │
│  (record)   │
└─────────────┘
```
> 含义：一个患者可以有多个复诊计划，也可以有多条治疗记录

---

## 🛠️ 第二部分：环境准备（第 1-2 天）

### 2.1 安装 MySQL 数据库（推荐 Docker 方式）

#### 方式一：使用 Docker（推荐，简单快捷）

**步骤 1：下载并安装 Docker Desktop**

1. 访问 Docker 官网：https://www.docker.com/products/docker-desktop/
2. 点击 "Download for Windows"
3. 双击下载的安装文件，一路点击 "Next" 完成安装
4. 安装完成后，重启电脑
5. 打开 Docker Desktop，看到绿色图标表示运行正常

**步骤 2：使用 Docker 启动 MySQL**

1. 在电脑任意位置新建一个文本文件，命名为 `start_mysql.txt`
2. 将以下命令复制到文件中：

```bash
docker run --name mysql-dental -e MYSQL_ROOT_PASSWORD=123456 -p 3306:3306 -d mysql:8.0 --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci
```

3. 保存文件，将文件名改为 `start_mysql.bat`（注意扩展名是 `.bat` 不是 `.txt`）
4. 双击运行这个 `.bat` 文件
5. 等待 1-2 分钟，MySQL 就启动成功了

**验证是否成功**：
- 打开 Docker Desktop，看到 `mysql-dental` 容器状态为 "Running"（绿色）即成功

---

#### 方式二：使用 MySQL Installer（传统方式）

**步骤 1：下载 MySQL Installer**

1. 访问 MySQL 官网下载页面：https://dev.mysql.com/downloads/installer/
2. 点击 "Download" 下载 `mysql-installer-community-8.0.xx.msi`
3. 如果提示登录，点击 "No thanks, just start my download."

**步骤 2：安装 MySQL**

1. 双击下载的安装文件
2. 选择 "Server only"（仅服务器）
3. 点击 "Next" → "Execute" → "Next"
4. 设置 root 密码为：`123456`（请牢记！）
5. 点击 "Next" → "Execute" → "Finish"
6. 安装完成

---

### 2.2 安装 DataGrip（数据库管理工具）

**步骤 1：下载 DataGrip**

1. 访问 JetBrains 官网：https://www.jetbrains.com/datagrip/
2. 点击 "Download" 下载 Windows 版本
3. 双击安装文件，一路点击 "Next" 完成安装

> 💡 **提示**：DataGrip 是付费软件，但提供 30 天免费试用。学生可使用教育邮箱申请免费许可证：https://www.jetbrains.com/community/education/

**步骤 2：创建数据库连接**

1. 打开 DataGrip
2. 点击左上角 "+" → `Data Source` → `MySQL`
3. 填写以下连接信息：
   - **Name**: `dental_clinic`
   - **Host**: `localhost`
   - **Port**: `3306`
   - **User**: `root`
   - **Password**: `123456`（点击密码框右侧图标设置）
4. 首次连接会提示下载 MySQL 驱动，点击 "Download" 自动下载
5. 点击 "Test Connection"，显示 "The test connection was successful" 表示成功
6. 点击 "OK" 保存

**步骤 3：熟悉 DataGrip 界面**

| 区域 | 功能 |
|------|------|
| **Database 面板**（左侧） | 查看所有数据库、表、视图等 |
| **查询控制台** | 编写和执行 SQL 脚本 |
| **Structure 面板** | 查看表结构、索引、外键等 |
| **Data Editor** | 可视化查看和编辑表数据 |

---

### 2.3 安装 Draw.io（画 ER 图工具）

**步骤 1：访问官网**

打开浏览器，访问：https://app.diagrams.net/

**步骤 2：开始使用**

1. 选择存储位置：选择 "Device"（本地设备）
2. 点击 "Create New Diagram"
3. 选择 "Entity Relationship" 模板
4. 开始画图！

---

## 📐 第三部分：数据库设计（第 3-5 天）

### 3.1 系统需要哪些数据？

我们的系统需要存储以下信息：

| 序号 | 数据类型 | 说明 | 对应表名 |
|------|----------|------|----------|
| 1 | 用户账号信息 | 医护人员的登录账号 | `users` |
| 2 | 患者基本信息 | 患者的个人信息 | `patients` |
| 3 | 治疗记录 | 患者做过的治疗 | `treatment_records` |
| 4 | 复诊计划 | 预约的复诊时间 | `appointments` |
| 5 | 对话记录 | 患者和 AI 的聊天记录 | `dialogues` |
| 6 | 知识库 | 牙科修复专业知识 | `knowledge_base` |
| 7 | 系统配置 | 系统运行参数 | `system_config` |

---

### 3.2 详细表结构设计

#### 表 1：用户表（users）- 存储医护人员账号

| 字段名 | 数据类型 | 说明 | 示例 |
|--------|----------|------|------|
| id | INT | 主键，自增 | 1, 2, 3... |
| username | VARCHAR(50) | 用户名（唯一） | `doctor_zhang` |
| password_hash | VARCHAR(255) | 加密后的密码 | `$2b$12$K...` |
| real_name | VARCHAR(50) | 真实姓名 | `张医生` |
| role | VARCHAR(20) | 角色 | `admin` 或 `doctor` |
| phone | VARCHAR(20) | 手机号 | `13800138000` |
| created_at | DATETIME | 创建时间 | `2026-02-21 10:00:00` |
| updated_at | DATETIME | 更新时间 | `2026-02-21 10:00:00` |

**主键**：`id`  
**唯一索引**：`username`

---

#### 表 2：患者表（patients）- 存储患者信息

| 字段名 | 数据类型 | 说明 | 示例 |
|--------|----------|------|------|
| id | INT | 主键，自增 | 1, 2, 3... |
| openid | VARCHAR(64) | 微信用户唯一标识（唯一） | `oAbCdEfGhIjKlMnOpQrStUvWx` |
| name | VARCHAR(50) | 姓名 | `李四` |
| gender | VARCHAR(10) | 性别 | `男` 或 `女` |
| age | INT | 年龄 | `35` |
| phone | VARCHAR(20) | 手机号 | `13900139000` |
| id_card | VARCHAR(18) | 身份证号（加密存储） | `530102199001011234` |
| medical_history | TEXT | 既往病史 | `高血压、糖尿病` |
| allergy_history | TEXT | 过敏史 | `青霉素过敏` |
| created_at | DATETIME | 注册时间 | `2026-02-21 10:00:00` |
| updated_at | DATETIME | 更新时间 | `2026-02-21 10:00:00` |

**主键**：`id`  
**唯一索引**：`openid`

---

#### 表 3：治疗记录表（treatment_records）- 存储患者治疗历史

| 字段名 | 数据类型 | 说明 | 示例 |
|--------|----------|------|------|
| id | INT | 主键，自增 | 1, 2, 3... |
| patient_id | INT | 外键，关联患者表 | `1` |
| treatment_type | VARCHAR(50) | 治疗类型 | `固定义齿修复` |
| treatment_date | DATE | 治疗日期 | `2026-01-15` |
| tooth_position | VARCHAR(50) | 牙位 | `左上 6` |
| material | VARCHAR(100) | 修复材料 | `全瓷牙` |
| dentist_id | INT | 外键，关联医生表 | `1` |
| notes | TEXT | 治疗备注 | `患者恢复良好` |
| created_at | DATETIME | 创建时间 | `2026-01-15 14:00:00` |

**主键**：`id`  
**外键**：`patient_id` → `patients(id)`，`dentist_id` → `users(id)`

---

#### 表 4：复诊计划表（appointments）- 存储复诊预约

| 字段名 | 数据类型 | 说明 | 示例 |
|--------|----------|------|------|
| id | INT | 主键，自增 | 1, 2, 3... |
| patient_id | INT | 外键，关联患者表 | `1` |
| appointment_date | DATETIME | 复诊日期时间 | `2026-03-15 09:00:00` |
| appointment_type | VARCHAR(50) | 复诊类型 | `术后复查` |
| status | VARCHAR(20) | 状态 | `pending`/`completed`/`cancelled` |
| reminder_sent | TINYINT | 是否已发送提醒 | `0` 未发送，`1` 已发送 |
| reminder_time | DATETIME | 提醒发送时间 | `2026-03-14 09:00:00` |
| notes | TEXT | 复诊备注 | `拆线` |
| created_at | DATETIME | 创建时间 | `2026-02-21 10:00:00` |
| updated_at | DATETIME | 更新时间 | `2026-02-21 10:00:00` |

**主键**：`id`  
**外键**：`patient_id` → `patients(id)`  
**索引**：`appointment_date`（加快日期查询）

---

#### 表 5：对话记录表（dialogues）- 存储 AI 对话日志

| 字段名 | 数据类型 | 说明 | 示例 |
|--------|----------|------|------|
| id | INT | 主键，自增 | 1, 2, 3... |
| patient_id | INT | 外键，关联患者表 | `1` |
| session_id | VARCHAR(64) | 会话 ID | `sess_abc123` |
| user_message | TEXT | 用户消息 | `医生，我种植牙多久能正常吃饭？` |
| ai_response | TEXT | AI 回复 | `一般种植牙术后 2-3 个月...` |
| message_type | VARCHAR(20) | 消息类型 | `consultation`/`reminder` |
| is_handover | TINYINT | 是否人工接管 | `0` 否，`1` 是 |
| created_at | DATETIME | 对话时间 | `2026-02-21 10:00:00` |

**主键**：`id`  
**外键**：`patient_id` → `patients(id)`  
**索引**：`session_id`、`created_at`

---

#### 表 6：知识库表（knowledge_base）- 存储牙科专业知识

| 字段名 | 数据类型 | 说明 | 示例 |
|--------|----------|------|------|
| id | INT | 主键，自增 | 1, 2, 3... |
| category | VARCHAR(50) | 知识分类 | `术后护理` |
| title | VARCHAR(200) | 知识标题 | `种植牙术后注意事项` |
| content | TEXT | 知识内容 | `1. 术后 24 小时内不要刷牙...` |
| keywords | VARCHAR(255) | 关键词（逗号分隔） | `种植牙，术后，注意事项` |
| source | VARCHAR(200) | 来源 | `《口腔修复学》第 8 版` |
| is_active | TINYINT | 是否启用 | `1` 启用，`0` 禁用 |
| created_at | DATETIME | 创建时间 | `2026-02-21 10:00:00` |
| updated_at | DATETIME | 更新时间 | `2026-02-21 10:00:00` |

**主键**：`id`  
**索引**：`category`、`keywords`

---

#### 表 7：系统配置表（system_config）- 存储系统参数

| 字段名 | 数据类型 | 说明 | 示例 |
|--------|----------|------|------|
| id | INT | 主键，自增 | 1, 2, 3... |
| config_key | VARCHAR(100) | 配置键（唯一） | `reminder_time` |
| config_value | TEXT | 配置值 | `09:00` |
| description | VARCHAR(255) | 配置说明 | `每日提醒发送时间` |
| created_at | DATETIME | 创建时间 | `2026-02-21 10:00:00` |
| updated_at | DATETIME | 更新时间 | `2026-02-21 10:00:00` |

**主键**：`id`  
**唯一索引**：`config_key`

---

### 3.3 绘制 ER 图（使用 Draw.io）

**步骤 1：打开 Draw.io**

1. 浏览器访问：https://app.diagrams.net/
2. 选择 "Device" → "Create New Diagram"
3. 选择 "Entity Relationship" 模板

**步骤 2：绘制 7 个实体（表）**

每个表画一个矩形框，格式如下：

```
┌─────────────────────────┐
│      users              │
├─────────────────────────┤
│ PK  id : INT            │
│     username : VARCHAR  │
│     password_hash : ... │
│     real_name : VARCHAR │
│     role : VARCHAR      │
│     phone : VARCHAR     │
│     created_at : DATETIME│
│     updated_at : DATETIME│
└─────────────────────────┘
```

**步骤 3：绘制关系连线**

- `users` → `treatment_records`：1 对多（一个医生有多条治疗记录）
- `patients` → `treatment_records`：1 对多（一个患者有多条治疗记录）
- `patients` → `appointments`：1 对多（一个患者有多个复诊计划）
- `patients` → `dialogues`：1 对多（一个患者有多条对话记录）

**步骤 4：导出图片**

1. 点击菜单栏 "File" → "Export as" → "PNG"
2. 保存为 `ER 图.png`
3. 保存到项目目录：`D:\Project\毕业设计\docs\数据库设计\ER 图.png`

---

## 💻 第四部分：创建数据库和表（第 6-7 天）

### 4.1 创建数据库

**步骤 1：打开 DataGrip**

1. 双击桌面 DataGrip 图标
2. 在左侧 Database 面板中找到 `dental_clinic` 连接

**步骤 2：执行创建数据库命令**

1. 右键点击连接 → `New` → `Console`（或按 `Ctrl+Shift+L`）
2. 在查询控制台输入以下命令：

```sql
-- 创建数据库
CREATE DATABASE IF NOT EXISTS dental_clinic
DEFAULT CHARACTER SET utf8mb4
DEFAULT COLLATE utf8mb4_unicode_ci;

-- 使用该数据库
USE dental_clinic;
```

**步骤 3：执行命令**

1. 选中上面的 SQL 代码
2. 点击绿色运行图标 ▶（或按 `Ctrl+Enter`）
3. 看到下方输出 "Query executed successfully" 表示成功

**步骤 4：刷新查看**

1. 在左侧 Database 面板右键 → `Refresh`（或按 `Ctrl+F5`）
2. 展开 `dental_clinic` → `Tables`，即可看到表

---

### 4.2 创建数据表（完整 SQL 脚本）

**新建 SQL 文件**

1. 在电脑上新建文本文件，命名为 `create_tables.sql`
2. 将以下所有 SQL 代码复制进去
3. 保存到：`D:\Project\毕业设计\docs\数据库设计\create_tables.sql`

**完整建表 SQL 脚本**：

```sql
-- ============================================
-- 数据库：dental_clinic
-- 描述：基于 AI 智能客服的牙科修复复诊提醒与管理系统
-- 创建日期：2026-02-21
-- ============================================

-- 使用数据库
USE dental_clinic;

-- ============================================
-- 表 1：用户表（users）- 医护人员账号
-- ============================================
DROP TABLE IF EXISTS `users`;
CREATE TABLE `users` (
    `id` INT NOT NULL AUTO_INCREMENT COMMENT '主键 ID',
    `username` VARCHAR(50) NOT NULL COMMENT '用户名',
    `password_hash` VARCHAR(255) NOT NULL COMMENT '加密密码',
    `real_name` VARCHAR(50) NOT NULL COMMENT '真实姓名',
    `role` VARCHAR(20) NOT NULL DEFAULT 'doctor' COMMENT '角色：admin/doctor',
    `phone` VARCHAR(20) DEFAULT NULL COMMENT '手机号',
    `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    `updated_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    PRIMARY KEY (`id`),
    UNIQUE KEY `uk_username` (`username`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='用户表';

-- ============================================
-- 表 2：患者表（patients）
-- ============================================
DROP TABLE IF EXISTS `patients`;
CREATE TABLE `patients` (
    `id` INT NOT NULL AUTO_INCREMENT COMMENT '主键 ID',
    `openid` VARCHAR(64) NOT NULL COMMENT '微信用户标识',
    `name` VARCHAR(50) NOT NULL COMMENT '姓名',
    `gender` VARCHAR(10) DEFAULT NULL COMMENT '性别',
    `age` INT DEFAULT NULL COMMENT '年龄',
    `phone` VARCHAR(20) DEFAULT NULL COMMENT '手机号',
    `id_card` VARCHAR(18) DEFAULT NULL COMMENT '身份证号',
    `medical_history` TEXT COMMENT '既往病史',
    `allergy_history` TEXT COMMENT '过敏史',
    `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '注册时间',
    `updated_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    PRIMARY KEY (`id`),
    UNIQUE KEY `uk_openid` (`openid`),
    KEY `idx_phone` (`phone`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='患者表';

-- ============================================
-- 表 3：治疗记录表（treatment_records）
-- ============================================
DROP TABLE IF EXISTS `treatment_records`;
CREATE TABLE `treatment_records` (
    `id` INT NOT NULL AUTO_INCREMENT COMMENT '主键 ID',
    `patient_id` INT NOT NULL COMMENT '患者 ID',
    `treatment_type` VARCHAR(50) NOT NULL COMMENT '治疗类型',
    `treatment_date` DATE NOT NULL COMMENT '治疗日期',
    `tooth_position` VARCHAR(50) DEFAULT NULL COMMENT '牙位',
    `material` VARCHAR(100) DEFAULT NULL COMMENT '修复材料',
    `dentist_id` INT DEFAULT NULL COMMENT '医生 ID',
    `notes` TEXT COMMENT '治疗备注',
    `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    PRIMARY KEY (`id`),
    KEY `idx_patient_id` (`patient_id`),
    KEY `idx_dentist_id` (`dentist_id`),
    KEY `idx_treatment_date` (`treatment_date`),
    CONSTRAINT `fk_tr_patient` FOREIGN KEY (`patient_id`) REFERENCES `patients` (`id`) ON DELETE CASCADE,
    CONSTRAINT `fk_tr_dentist` FOREIGN KEY (`dentist_id`) REFERENCES `users` (`id`) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='治疗记录表';

-- ============================================
-- 表 4：复诊计划表（appointments）
-- ============================================
DROP TABLE IF EXISTS `appointments`;
CREATE TABLE `appointments` (
    `id` INT NOT NULL AUTO_INCREMENT COMMENT '主键 ID',
    `patient_id` INT NOT NULL COMMENT '患者 ID',
    `appointment_date` DATETIME NOT NULL COMMENT '复诊日期',
    `appointment_type` VARCHAR(50) NOT NULL COMMENT '复诊类型',
    `status` VARCHAR(20) NOT NULL DEFAULT 'pending' COMMENT '状态：pending/completed/cancelled',
    `reminder_sent` TINYINT NOT NULL DEFAULT 0 COMMENT '是否已发送提醒：0/1',
    `reminder_time` DATETIME DEFAULT NULL COMMENT '提醒发送时间',
    `notes` TEXT COMMENT '复诊备注',
    `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    `updated_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    PRIMARY KEY (`id`),
    KEY `idx_patient_id` (`patient_id`),
    KEY `idx_appointment_date` (`appointment_date`),
    KEY `idx_status` (`status`),
    CONSTRAINT `fk_app_patient` FOREIGN KEY (`patient_id`) REFERENCES `patients` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='复诊计划表';

-- ============================================
-- 表 5：对话记录表（dialogues）
-- ============================================
DROP TABLE IF EXISTS `dialogues`;
CREATE TABLE `dialogues` (
    `id` INT NOT NULL AUTO_INCREMENT COMMENT '主键 ID',
    `patient_id` INT NOT NULL COMMENT '患者 ID',
    `session_id` VARCHAR(64) NOT NULL COMMENT '会话 ID',
    `user_message` TEXT NOT NULL COMMENT '用户消息',
    `ai_response` TEXT NOT NULL COMMENT 'AI 回复',
    `message_type` VARCHAR(20) NOT NULL DEFAULT 'consultation' COMMENT '消息类型',
    `is_handover` TINYINT NOT NULL DEFAULT 0 COMMENT '是否人工接管：0/1',
    `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '对话时间',
    PRIMARY KEY (`id`),
    KEY `idx_patient_id` (`patient_id`),
    KEY `idx_session_id` (`session_id`),
    KEY `idx_created_at` (`created_at`),
    CONSTRAINT `fk_dia_patient` FOREIGN KEY (`patient_id`) REFERENCES `patients` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='对话记录表';

-- ============================================
-- 表 6：知识库表（knowledge_base）
-- ============================================
DROP TABLE IF EXISTS `knowledge_base`;
CREATE TABLE `knowledge_base` (
    `id` INT NOT NULL AUTO_INCREMENT COMMENT '主键 ID',
    `category` VARCHAR(50) NOT NULL COMMENT '知识分类',
    `title` VARCHAR(200) NOT NULL COMMENT '知识标题',
    `content` TEXT NOT NULL COMMENT '知识内容',
    `keywords` VARCHAR(255) DEFAULT NULL COMMENT '关键词',
    `source` VARCHAR(200) DEFAULT NULL COMMENT '来源',
    `is_active` TINYINT NOT NULL DEFAULT 1 COMMENT '是否启用：0/1',
    `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    `updated_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    PRIMARY KEY (`id`),
    KEY `idx_category` (`category`),
    KEY `idx_keywords` (`keywords`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='知识库表';

-- ============================================
-- 表 7：系统配置表（system_config）
-- ============================================
DROP TABLE IF EXISTS `system_config`;
CREATE TABLE `system_config` (
    `id` INT NOT NULL AUTO_INCREMENT COMMENT '主键 ID',
    `config_key` VARCHAR(100) NOT NULL COMMENT '配置键',
    `config_value` TEXT NOT NULL COMMENT '配置值',
    `description` VARCHAR(255) DEFAULT NULL COMMENT '配置说明',
    `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    `updated_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    PRIMARY KEY (`id`),
    UNIQUE KEY `uk_config_key` (`config_key`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='系统配置表';
```

**执行建表脚本**

1. 打开 DataGrip，连接到数据库
2. 右键点击连接 → `New` → `Console`（或按 `Ctrl+Shift+L`）
3. 点击工具栏上的文件夹图标 📁，选择 `Open...`（或按 `Ctrl+O`）
4. 选择 `create_tables.sql` 文件
5. 点击绿色运行图标 ▶ 执行（或按 `Ctrl+Enter`）
6. 左侧刷新，看到 7 张表即成功

---

### 4.3 插入测试数据

**新建初始化数据 SQL 文件**

1. 新建文本文件，命名为 `init_data.sql`
2. 保存到：`D:\Project\毕业设计\docs\数据库设计\init_data.sql`

**测试数据脚本**：

```sql
-- ============================================
-- 初始化测试数据
-- 执行日期：2026-02-21
-- ============================================

USE dental_clinic;

-- ============================================
-- 1. 插入用户数据（医护人员）
-- ============================================
INSERT INTO `users` (`username`, `password_hash`, `real_name`, `role`, `phone`) VALUES
('admin', '$2b$12$LQv3c1yqBWVHxkd0LHAkCOYz6TtxMQJqhN8/X4.G.2f2f2f2f2f2f', '系统管理员', 'admin', '13800138000'),
('doctor_zhang', '$2b$12$LQv3c1yqBWVHxkd0LHAkCOYz6TtxMQJqhN8/X4.G.2f2f2f2f2f2f', '张医生', 'doctor', '13800138001'),
('doctor_li', '$2b$12$LQv3c1yqBWVHxkd0LHAkCOYz6TtxMQJqhN8/X4.G.2f2f2f2f2f2f', '李医生', 'doctor', '13800138002');

-- ============================================
-- 2. 插入患者数据
-- ============================================
INSERT INTO `patients` (`openid`, `name`, `gender`, `age`, `phone`, `medical_history`, `allergy_history`) VALUES
('oAbCdEfGhIjKlMnOpQrStUvWx', '张三', '男', 45, '13900139001', '高血压', '无'),
('oAbCdEfGhIjKlMnOpQrStUvWy', '李四', '女', 38, '13900139002', '无', '青霉素过敏'),
('oAbCdEfGhIjKlMnOpQrStUvWz', '王五', '男', 52, '13900139003', '糖尿病', '无'),
('oAbCdEfGhIjKlMnOpQrStUvW0', '赵六', '女', 29, '13900139004', '无', '无'),
('oAbCdEfGhIjKlMnOpQrStUvW1', '孙七', '男', 61, '13900139005', '高血压、冠心病', '磺胺类过敏');

-- ============================================
-- 3. 插入治疗记录数据
-- ============================================
INSERT INTO `treatment_records` (`patient_id`, `treatment_type`, `treatment_date`, `tooth_position`, `material`, `dentist_id`, `notes`) VALUES
(1, '固定义齿修复', '2026-01-15', '左上 6', '全瓷牙', 2, '患者恢复良好'),
(1, '种植牙手术', '2026-02-10', '右下 6', 'ITI 种植体', 2, '手术顺利'),
(2, '活动义齿修复', '2026-01-20', '上颌', '钴铬合金', 3, '初戴适应中'),
(3, '固定义齿修复', '2026-02-05', '左下 6、7', '烤瓷牙', 2, '已完成'),
(4, '种植牙手术', '2026-02-18', '左上 4', '奥齿泰种植体', 3, '术后恢复中'),
(5, '活动义齿修复', '2026-01-10', '下颌', '纯钛支架', 2, '定期复查');

-- ============================================
-- 4. 插入复诊计划数据
-- ============================================
INSERT INTO `appointments` (`patient_id`, `appointment_date`, `appointment_type`, `status`, `notes`) VALUES
(1, '2026-03-15 09:00:00', '种植牙复查', 'pending', '检查骨结合情况'),
(1, '2026-05-15 09:00:00', '固定义齿复查', 'pending', '戴牙后复查'),
(2, '2026-03-01 14:00:00', '活动义齿调整', 'pending', '初戴后调整'),
(3, '2026-03-10 10:00:00', '固定义齿复查', 'pending', '戴牙后复查'),
(4, '2026-03-20 09:00:00', '种植牙二期', 'pending', '安装愈合基台'),
(5, '2026-02-28 15:00:00', '活动义齿复查', 'pending', '适应性检查');

-- ============================================
-- 5. 插入对话记录数据（示例）
-- ============================================
INSERT INTO `dialogues` (`patient_id`, `session_id`, `user_message`, `ai_response`, `message_type`) VALUES
(1, 'sess_001', '医生，我种植牙多久能正常吃饭？', '一般种植牙术后 2-3 个月可以正常咀嚼食物。但具体情况因人而异，建议您术后 1 周内吃软食，1 个月内避免用手术侧咀嚼硬物。请按时复诊，医生会根据您的恢复情况给出具体建议。', 'consultation'),
(2, 'sess_002', '活动义齿刚戴上很不舒服，正常吗？', '活动义齿初戴时有轻微不适是正常的，一般需要 1-2 周适应期。如果出现明显疼痛、溃疡或无法咀嚼，请及时复诊调整。建议您先吃软食，逐渐适应后再恢复正常饮食。', 'consultation'),
(3, 'sess_003', '烤瓷牙能用多久？', '烤瓷牙的使用寿命一般为 10-15 年，良好的口腔卫生和定期复查可以延长使用寿命。建议您每天认真刷牙、使用牙线，每半年到一年复查一次。', 'consultation');

-- ============================================
-- 6. 插入知识库数据（示例）
-- ============================================
INSERT INTO `knowledge_base` (`category`, `title`, `content`, `keywords`, `source`) VALUES
('术后护理', '种植牙术后注意事项', '1. 术后 24 小时内不要刷牙，可用漱口水漱口\n2. 术后 1-2 天内避免剧烈运动\n3. 术后 1 周内避免用手术侧咀嚼食物\n4. 按医嘱服用抗生素和止痛药\n5. 如有持续出血、剧烈疼痛或发热，请及时就医\n6. 按时复诊，一般术后 7 天拆线，3-6 个月进行二期手术', '种植牙，术后护理，注意事项', '《口腔修复学》第 8 版'),
('术后护理', '固定义齿佩戴注意事项', '1. 初戴固定义齿时，如有轻微不适属正常现象\n2. 避免咬硬物，如冰块、坚果壳等\n3. 保持良好的口腔卫生，每天刷牙 2 次\n4. 使用牙线清洁义齿与真牙之间的缝隙\n5. 定期复查，一般每 6-12 个月复查一次\n6. 如出现松动、疼痛或破损，请及时就医', '固定义齿，注意事项，护理', '《口腔修复学》第 8 版'),
('术后护理', '活动义齿使用指南', '1. 初戴活动义齿时，可能有异物感，一般 1-2 周可适应\n2. 饭后应取下义齿清洗，并漱口\n3. 睡前取下义齿，浸泡在清水中\n4. 避免用热水清洗义齿，以免变形\n5. 定期复查，一般每 6 个月复查一次\n6. 如义齿破损或不适，请及时就医调整', '活动义齿，使用指南，护理', '《口腔修复学》第 8 版'),
('常见问题', '种植牙的寿命有多长？', '种植牙的平均寿命为 10-20 年，甚至更长。影响种植牙寿命的因素包括：\n1. 患者的口腔卫生习惯\n2. 定期复查和维护\n3. 吸烟、饮酒等不良习惯\n4. 全身健康状况（如糖尿病等）\n5. 种植体的品牌和质量', '种植牙，寿命，使用年限', '临床指南'),
('常见问题', '什么情况下需要做牙冠修复？', '以下情况建议做牙冠修复：\n1. 牙齿大面积缺损，无法用充填材料修复\n2. 根管治疗后的牙齿，需要保护\n3. 牙齿颜色或形态异常，影响美观\n4. 作为固定义齿的基牙\n5. 种植牙上部修复', '牙冠，适应症，修复', '《口腔修复学》第 8 版');

-- ============================================
-- 7. 插入系统配置数据
-- ============================================
INSERT INTO `system_config` (`config_key`, `config_value`, `description`) VALUES
('reminder_time', '09:00', '每日复诊提醒发送时间'),
('reminder_advance_hours', '24', '提前多少小时发送提醒'),
('ai_max_tokens', '512', 'AI 回复最大 token 数'),
('ai_temperature', '0.7', 'AI 生成温度参数'),
('session_timeout_minutes', '30', '会话超时时间（分钟）');
```

**执行初始化脚本**

1. 打开 DataGrip
2. 右键点击连接 → `New` → `Console`
3. 点击工具栏上的文件夹图标 📁，选择 `Open...`（或按 `Ctrl+O`）
4. 选择 `init_data.sql`
5. 点击绿色运行图标 ▶ 执行（或按 `Ctrl+Enter`）
6. 看到 "Affected Rows: XX" 表示成功

---

### 4.4 验证数据是否成功

**查询验证**

在 DataGrip 中新建查询控制台，执行以下 SQL：

```sql
-- 查看所有表
SHOW TABLES;

-- 查看患者数据
SELECT * FROM patients;

-- 查看复诊计划
SELECT * FROM appointments;

-- 查看知识库数据
SELECT * FROM knowledge_base;
```

如果能看到数据，说明一切正常！✅

---

## 📄 第五部分：编写数据库设计文档（第 8 天）

### 5.1 创建数据字典文档

**新建文档**

1. 新建文本文件，命名为 `数据字典.md`
2. 保存到：`D:\Project\毕业设计\docs\数据库设计\数据字典.md`

**数据字典内容**（复制以下模板，根据实际情况修改）：

```markdown
# 数据库设计文档

## 1. 数据库概述

- **数据库名称**：dental_clinic
- **数据库描述**：基于 AI 智能客服的牙科修复复诊提醒与管理系统
- **字符集**：utf8mb4
- **排序规则**：utf8mb4_unicode_ci
- **设计日期**：2026-02-21

## 2. 数据表清单

| 序号 | 表名 | 中文名称 | 记录数 | 说明 |
|------|------|----------|--------|------|
| 1 | users | 用户表 | 3 | 存储医护人员账号信息 |
| 2 | patients | 患者表 | 5 | 存储患者基本信息 |
| 3 | treatment_records | 治疗记录表 | 6 | 存储患者治疗历史 |
| 4 | appointments | 复诊计划表 | 6 | 存储复诊预约信息 |
| 5 | dialogues | 对话记录表 | 3 | 存储 AI 对话日志 |
| 6 | knowledge_base | 知识库表 | 5 | 存储牙科专业知识 |
| 7 | system_config | 系统配置表 | 5 | 存储系统参数配置 |

## 3. 表结构详解

### 3.1 users - 用户表

**表说明**：存储医护人员账号信息

| 字段名 | 类型 | 长度 | 允许 NULL | 默认值 | 说明 |
|--------|------|------|-----------|--------|------|
| id | INT | - | 否 | 自增 | 主键 ID |
| username | VARCHAR | 50 | 否 | - | 用户名（唯一） |
| password_hash | VARCHAR | 255 | 否 | - | 加密密码 |
| real_name | VARCHAR | 50 | 否 | - | 真实姓名 |
| role | VARCHAR | 20 | 否 | doctor | 角色：admin/doctor |
| phone | VARCHAR | 20 | 是 | NULL | 手机号 |
| created_at | DATETIME | - | 否 | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | DATETIME | - | 否 | CURRENT_TIMESTAMP | 更新时间 |

**索引**：
- 主键索引：`id`
- 唯一索引：`username`

---

### 3.2 patients - 患者表

（按照上面格式，继续编写其他表的文档...）
```

---

## ✅ 第六部分：检查清单

完成以上所有步骤后，请对照以下清单检查：

### 环境准备
- [ ] MySQL 数据库已安装并运行
- [ ] DataGrip 可以正常连接
- [ ] Draw.io 可以正常使用

### 数据库设计
- [ ] 已完成 7 张表的设计
- [ ] 已绘制 ER 图并保存
- [ ] 已编写数据字典文档

### 数据库创建
- [ ] 数据库 `dental_clinic` 已创建
- [ ] 7 张表已成功创建
- [ ] 测试数据已成功插入
- [ ] 可以正常查询数据

### 文档输出
- [ ] `ER 图.png` 已保存
- [ ] `create_tables.sql` 已保存
- [ ] `init_data.sql` 已保存
- [ ] `数据字典.md` 已编写完成

---

## 📂 最终目录结构

完成后，你的项目目录应该是这样的：

```
D:\Project\毕业设计\
├── docs\
│   └── 数据库设计\
│       ├── ER 图.png
│       ├── 数据字典.md
│       ├── create_tables.sql
│       └── init_data.sql
└── 01-数据库设计与搭建指南.md（本文档）
```

---

## 🆘 常见问题解答

### Q1：Docker 启动 MySQL 失败怎么办？

**A**：检查以下几点：
1. Docker Desktop 是否正常运行（右下角鲸鱼图标）
2. 3306 端口是否被占用（执行 `netstat -ano | findstr 3306`）
3. 如被占用，修改 Docker 命令中的端口：`-p 3307:3306`

### Q2：DataGrip 连接失败怎么办？

**A**：检查：
1. MySQL 服务是否运行（Docker Desktop 中容器状态为 Running）
2. 用户名密码是否正确
3. 主机名是否为 `localhost`
4. 端口是否为 `3306`
5. 首次连接时是否下载了 MySQL 驱动

### Q3：DataGrip 无法执行 SQL 脚本怎么办？

**A**：
1. 确保已选中正确的 SQL 代码
2. 检查是否使用了正确的执行快捷键（`Ctrl+Enter`）
3. 查看下方 Output 窗格的具体错误信息
4. 确保已选择正确的数据库（`USE dental_clinic;`）

### Q4：执行 SQL 脚本报错怎么办？

**A**：
1. 检查是否先执行了 `CREATE DATABASE`
2. 检查是否先执行了 `USE dental_clinic`
3. 查看具体错误信息，通常是语法错误或表已存在

### Q5：外键约束报错怎么办？

**A**：外键要求先创建主表（如 `patients`），再创建从表（如 `treatment_records`）。确保 SQL 脚本中表的创建顺序正确。

---

## 📞 需要帮助？

如果遇到问题：
1. 仔细阅读本文档每一处说明
2. 检查常见问题解答
3. 记录具体错误信息，向指导老师请教

---

## 📂 附录：数据库文档结构说明

本项目数据库相关文档统一存放在 `docs/数据库设计/` 目录下，结构如下：

```
docs/数据库设计/
├── ER 图.md           -- 实体关系图设计文档（含 Mermaid 源码）
├── 数据字典.md         -- 详细表结构说明文档
├── create_tables.sql  -- 建表 SQL 脚本（仅包含建表语句）
└── init_data.sql      -- 初始化数据 SQL 脚本（仅包含测试数据）
```

### 各文档用途说明

| 文档名称 | 用途 | 主要内容 |
|----------|------|----------|
| **ER 图.md** | 数据库概念设计 | 实体列表、属性说明、实体关系、Mermaid ER 图 |
| **数据字典.md** | 数据库逻辑设计 | 表结构详解、字段说明、索引设计、外键约束 |
| **create_tables.sql** | 物理实现 | 创建数据库、创建 7 张表的完整 SQL 脚本 |
| **init_data.sql** | 数据初始化 | 插入测试用户、患者、治疗记录、复诊计划等数据 |

### 使用顺序

1. 先阅读 **ER 图.md** 了解整体数据模型
2. 查阅 **数据字典.md** 了解详细表结构
3. 执行 **create_tables.sql** 创建数据库和表
4. 执行 **init_data.sql** 插入测试数据

---

**文档版本**：v1.2
**编写日期**：2026-02-21
**适用对象**：毕业设计初学者

**下一步**：完成数据库设计后，进入第二步——FastAPI 后端框架搭建
